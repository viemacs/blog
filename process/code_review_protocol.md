# Code Review

#### 为什么做 Code Review
做 Code review 是为了改进代码质量. 通过对代码, 测试过程和注释进行检查, 来确认方案设计和代码实现.

Code review 的主要目的是

1. 在项目早期就能够发现代码中的BUG 
2. 帮助初级开发人员学习高级开发人员的经验，达到知识共享 
3. 避免开发人员犯一些很常见，很普通的错误 
4. 保证项目组人员的良好沟通 
5. 项目或产品的代码更容易维护 

在开发过程中, 对源代码进行系统检查.
查找代码缺陷,
检查功能实现,
编码合理性,
性能优化.


#### 准备工作

1. 参与人对自己在 code review 要做什么, 要学什么有基本的了解
2. 代码能正确运行/编译, 功能基本正确
3. 代码能通过单元测试和测试用例
4. 做 review 的人对代码有基本的了解,
   代码的功能是什么, 涉及什么系统的什么方面, 对性能,稳定等方面有什么特别的需求,
   好有针对性地检查代码

Code review 前代码的语法和功能问题应该已经解决, review 的重点在代码质量上.


#### Review 项目
基本方面
- 代码一致性
- 代码安全问题
- 代码冗余
- 设计的正确性
- 性能与功能需求

次要方面
- 编码风格

代码中使用的格式、符号、结构等风格是否保持一致 

1. 完整性 completeness
    1. 完全实现设计文档中的功能需求
	2. 创建并初始化了所需要的数据库
	3. 去除了未定义或未使用的变量, 常量, 类
2. 一致性 consistency
    1. 代码逻辑与文档中逻辑是否一致
	2. 代码中的算法符合文档中的数学模型
3. 正确性 correctness
	1. 注释准确完整
	2. 函数调用参数传递正确
	3. 变量定义和使用方式正确
    4. 代码组织方式符合制定的标准
4. 清晰性 clearness
    1. 所需的数据字典, 接口说明, 描述如何访问常量, 变量, 功能
    2. 配置, 定义文件是否易于理解, 修改
	3. 功能模块功能的入口和出口明确, 唯一
	4. 函数的出口唯一 (异常处理除外)
    5. 每个功能都是一个可辩识的代码块
5. 可预测性 predictability
    1. 代码语言中常见陷阱已检测并排除
	2. 是否有依赖于开发工具环境语言缺省提供的功能
	3. 代码中没有死循环, 无穷递归
6. 健壮性 robustness
    - 采取措施避免运行时错误: 数组边界溢出, 被零除, 值越界, 堆栈溢出, etc
7. 可追溯性 traceability
    1. 每个程序有唯一标识
	2. 代码和开发文档之间有交叉引用(框架)可以相互对应
	3. 代码版本管理中对代码的修改和原因都有易于理解的记录
8. 可读性 readability
    1. 注释清晰描述了每个子程序
	2. 复杂代码有必要的使用理由, 注释清楚明确
	3. 使用一些统一的格式化技巧（如缩进、空白等）用来增强代码的清晰度
	4. 变量, 函数的命名清楚反映含义, 便于记忆, 书写
	5. 变量都有合理合法的取值范围
9. 可验证性 verifiability
    - 代码中功能的实现方式便于测试

#### Review 步骤
1. 作者向参与review的人按用例或功能依次讲解自己的代码功能, 相关逻辑
2. reviewer 提出疑问, 组织者对存在的问题做记录
3. reviewer 自己对代码进行审核, 并把问题和修改建议记录在表中
4. 组织者把各reviewer的代码问题记录表汇总成"review报告", 记录发现的问题和修改建议，然后把"review报告"发送给相关人员
5. 作者根据"review报告"的修改意见修改代码, 有不清楚的地方和reviewer进行交流
6. 作者在过完 issue 之后作出反馈
7. 组织者把 Code Review 中发现的有价值的问题更新到 "code review 规范" 文档中
8. 对值得提醒和注意的问题可 email 给所有技术人员

#### 所需方档
- "code review规范"
- issue 记录表: id, issue-type, critical-level, description, ; reviewer, review-time(hour)
    - issue-type: logic, function, style, typo, ...
	- critical-level: {  
	  0: 无关紧要, 不应出现, 如typo,  
	  1: 轻微, 如风格错误,  
	  2: 局部, 如不能过单元测试的 bug,  
	  3: 重要, 可能影响正常运行, 如关键业务上缺少检测,  
	  4: 严重, 影响正常运行, 如逻辑错误, 性能不足,  
	  5: 重大, 影响正常使用, 如功能错误,  
	  6: 会导致系统无法运行  
	  }
- issue 汇总表: id, issue-type, critical-level, description, reviewer, p-level, review-time(hour)
- issue 解决表: id, state, desc, solution, reviewer
- meeting 记录: timestamp, time, organizer, attenders, output,  
  [author, issue, solution, reviewer, ...],  
- output to protocol documents

----

----

----

一起来做review时，更重要的是看程序逻辑和需求实现。

Code Review 主要目的是审核代码的质量:

- 可读性
- 可维护性
- 程序逻辑
- 对需求和设计的实现

- 查找系统缺陷
- 保证代码质量
- 相互学习，提高开发者水平
- 确定作者的设计和实现清晰，简单
- 传递作者的意图和想法，使其他人可以更加熟悉代码，利于维护代码和改进代码

提高代码质量
评审过程使大家更多的理解系统，重构思路，


保证软件质量
提高开发者自身水平

##### 次要目的
- 查找程序的bug
- 保证代码风格和编码标准

消除 Bug 主要靠测试. 由单元测试，功能测试，性能测试，回归测试来消除Bug。
单元测试为主。单元测试最接近bug，bug没有扩散的地方。
在 code review 之前，要有单元测试和单元测试报告，

代码风格和编码标准是确定的, 是靠个人可以做到的, 所以在代码提交时就应该是符合规范的。
代码规范，有作者自己和一些检查代码规范的工具。


## GIT
1. 提交日志有明确的含义，明确此次提交的内容或目的
像“修改了某文件”，“更行了某文件”提供的信息太少。

写日志时考虑log的目的是在查找修改bug，版本回滚，代码评审等过程中提供有效的信息。

2. 提交的大小
提交的代码太多，不便于代码评审和版本控制.
提交太多太小的修改，会影响版本和日志的可读性。
可以参考的做法是，对一个模块完成修改，昨晚单元测试后，压缩commit之后提交。

避免的做法：提交未测试的代码，出现问题后提交很多小的修改。


整理思路，流程的实现方法， 代码的组织方法（不是风格）


------------------------------------
Code Review 代码审查

Code Review 代码审查	1
1．关于Code Review	2
1.1 Code Review的目的	2
1.2 Code Review的前提	2
1.3 Code Review需要做什么	2
1.3.1  完整性检查（Completeness）	3
1.3.2  一致性检查（Consistency）	3
1.3.3  正确性检查（Correctness）	3
1.3.4  可修改性检查（Modifiability）	3
1.3.5  可预测性检查（Predictability）	3
1.3.6  健壮性检查（Robustness）	3
1.3.7  结构性检查（Structuredness）	3
1.3.8  可追溯性检查（Traceability）	4
1.3.9  可理解性检查（Understandability）	4
1.3.10 可验证性检查(Verifiability)	4
1.4  Code Review的步骤	4
2．Code Reivew的执行	5
2.1．事前准备阶段	5
2.1.1．CR的对象	5
2.1.2．CR的内容	5
2.1.3．评审规范和标准	5
2.1.4．选择CR活动的参与者	5
2.1.5．选择CR活动的实施方式。	5
2.2．实施阶段	6
2.2.1．准确记录	6
2.2.2．讲解与提问	6
2.2.3．逐项审查	6
2.2.4．注意气氛	6
2.3. 事后跟踪跟踪。	6
2.3.1. 确认发现的问题	6
2.32. 修正问题责任者	6
2.3.3. 修正结果确认者	7
3．注意事项	7
3.1. 经常进行Code Review	7
3.2.  Code Review不要太正式，而且要短	7
3.3. 尽可能的让不同的人Reivew你的代码	7
3.4. 保持积极的正面的态度	8
3.5. 学会享受Code Reivew	8
相关资料	8
资料来源	8

------------------------------------


2．Code Reivew的执行
一个标准的Code Reivew活动应该分为三个阶段：
2.1．事前准备阶段
在一次CR前，对以下内容进行充分准备。
2.1.1．CR的对象
在准备CR代码对象时，我们要注意代码的数量，如果代码量比较大，要对代码进行必要的分解，确定其中的关键代码，对关键代码进行CR，可以达到举一反三的目的。
2.1.2．CR的内容
我们对代码的审查内容很多，如代码的编写是否规范（注释的书写格式、命名规范等）、技术处理规范（异常处理、日志处理、代码组织结构等）、业务实现等。我们不能希望通过一次CR活动，完成所有这些内容的审查，因此我们必须设定本次CR活动内容界限，确定审查重点；
2.1.3．评审规范和标准
在CR前设计确定评审规范和标准是必要，通过规范和标准我们在审查过程中可以有据可依，有理可循，而且还可以做到标准统一。
2.1.4．选择CR活动的参与者
在CR开始前，必须把本次CR活动的对象、审查内容以及审查的规范和标准通报给所有的参与者。
2.1.5．选择CR活动的实施方式。
CR活动有很多形式可供我们选择，我们可以根据实际情况选择桌面式CR、演示讲解式CR、一对一的座位CR等等。

2.2．实施阶段
充分的事前准备，只是做好CR活动的前提，在CR实施过程中，我们要做好以下工作。
2.2.1．准确记录
对于CR过程发现的问题，我们必须清晰准确的记录，可以使用问题点记录单，明确记录的项目和内容。
2.2.2．讲解与提问
CR过程中，要采用代码作者讲解和审查者提问方式。审查者不能只在发现问题时提问，同时也要根据本次审查的内容要求代码作者对某个特定问题的讲解。
2.2.3．逐项审查
对事前确定的审查内容，要逐项审查，不能因为时间不足等因素一扫而过。
2.2.4．注意气氛
实施审查时，要营造一个讨论问题、解决问题的氛围，不能把审查会搞成批判会，这样会影响相关人员的积极性。
2.3. 事后跟踪跟踪。
2.3.1. 确认发现的问题
CR结束后，对发现的问题，首先需要确定以下内容。
1．问题点的难易程度以及影响的范围；
2．解决问题的责任者和问题点修正结果的确认者；
3．解决问题点的时限。
2.32. 修正问题责任者
对于修正问题责任者，在问题点的修正过程中，要三方面内容的记录。
1．问题点的原因；
2．解决问题点的对策；
3．修正的内容。
2.3.3. 修正结果确认者
做为修正结果的确认者，必须按照事前约定的时限及时的对修正结果进行全面的确认

3．注意事项
3.1. 经常进行Code Review
（1）要Review的代码越多，那么要重构，重写的代码就会越多。而越不被程序作者接受的建议也会越多，唾沫口水战也会越多。
（2）程序员代码写得时候越长，程序员就会在代码中加入越来越多的个人的东西。 
（3）越接近软件发布的最终期限，代码也就不能改得太多。
3.2.  Code Review不要太正式，而且要短
忘了那个代码评审的Checklist吧，走到你的同事座位跟前，像请师父一样请他坐到你的电脑面前，然后，花5分钟给他讲讲你的代码，给他另外一个5分钟让他给你的代码提提意见，这比什么都好。而如果你用了一个Checklist，让这个事情表现得很正式的话，下面两件事中必有一件事会发生：
（1）只有在Checklist上存在的东西才会被Review。
（2）Code Reviews 变成了一种礼节性的东西，你的同事会装做很关心你的代码，但其实他心里想着尽快地离开你。
只有不正式的Code Review才会让你和评审者放轻松，人只有放松了，才会表现得很真实，很真诚。记住Review只不过是一种形式，而只有在相互信任中通过相互的讨论得到了有意义和有建设性的建议和意见，那才是最实在的。不然，作者和评审者的关系就会变成小偷和警察的关系。

3.3. 尽可能的让不同的人Reivew你的代码
如果可能的话，不要总是只找一个人来Review你的代码，不同的人有不同的思考方式，有不同的见解，所以，不同的人可以全面的从各个方面评论你的代码。
但不要太多了，人多嘴杂反而适得其反，基本上来说，不要超过3个人，这是因为，这是一个可以围在一起讨论的最大人员尺寸。

下面是几个优点：
（1）从不同的方向评审代码总是好的。
（2）会有更多的人帮你在日后维护你的代码。
（3）这也是一个增加团队凝聚力的方法。
3.4. 保持积极的正面的态度
程序员最大的问题就是“自负”，尤其当我们Reivew别人的代码的时候，我已经见过无数的场面，程序员在Code Review的时候，开始抨击别人的代码，质疑别人的能力。太可笑了，我分析了一下，这类的程序员其实并没有什么本事，因为他们指责对方的目的是想告诉大家自己有多么的牛，靠这种手段来表现自己的程序员，其实是就是传说中所说的“半瓶水”。

所以，无论是代码作者，还是评审者，都需要一种积极向上的正面的态度，作者需要能够虚心接受别人的建议，因为别人的建议是为了让你做得更好；评审者也需要以一种积极的正面的态度向作者提意见，因为那是和你在一个战壕里的战友。记住，你不是一段代码，你是一个人！

3.5. 学会享受Code Reivew
这可能是最重要的一个提示了，如果你到了一个人人都喜欢Code Reivew的团阿，那么，你会进入到一个生机勃勃的地方，在那里，每个人都能写出质量非常好的代码，在那里，你不需要经理的管理，团队会自适应一切变化，他们相互学习，相互帮助，不仅仅是写出好的代码，而且团队和其中的每个人都会自动进化，最关键的是，这个是一个团队。


相关资料
5个开源的代码审查工具 http://coolshell.cn/articles/1218.html

资料来源
Code Reivew的执行http://www.cnblogs.com/dinofung/articles/2302957.html
Code Review中的几个提示http://coolshell.cn/articles/1302.html
什么是Code Review http://www.cnblogs.com/wdpp/archive/2011/01/17/2386823.html
web项目经理手册-Code Review http://blog.csdn.net/yzhz/article/details/1669802

博客园 唐小熊于2012-7-4整理
